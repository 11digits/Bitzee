<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6ae3ff">
<link rel="apple-touch-icon" href="cat-icon.svg">
<title>Catzee</title>
<style>
    :root{
      --bg:#0f1220; --panel:#1b2038; --accent:#6ae3ff; --good:#4cd964; --warn:#ffcc00; --bad:#ff4d4f; --text:#e9f1ff;
      --cat1:#6ae3ff; --cat2:#2bdfff; --catInner:#66d6ff;
    }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
    color:var(--text); background:radial-gradient(1200px 800px at 20% 10%, #1a1f35 0, #0f1220 45%, #0b0e19 100%);
    display:flex; flex-direction:column; align-items:center; justify-content:center; padding:16px;
    touch-action:manipulation;
  }
  body.boy{
    background:radial-gradient(1200px 800px at 20% 10%, #1a1f35 0, #0f1220 45%, #0b0e19 100%);
  }
  body.girl{
    background:radial-gradient(1200px 800px at 20% 10%, #351a35 0, #200f14 45%, #190b20 100%);
  }
  .game{
    position:relative;
    width:min(440px, 94vw); background:var(--panel); border-radius:16px; padding:14px; box-shadow:0 12px 40px rgba(0,0,0,.4);
    border:1px solid rgba(255,255,255,.06);
  }
  .top{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px}
  .title{font-weight:700; letter-spacing:.2px}
  .clock{opacity:.8; font-variant-numeric:tabular-nums}
  .stars{text-align:center; margin-bottom:6px; font-size:18px; letter-spacing:2px}
  .app-name{text-align:center; font-weight:700; font-size:24px; margin-bottom:8px; font-family:'Comic Sans MS','Comic Sans',cursive}
  .viewport{
    position:relative; aspect-ratio:1.4/1; background:
      radial-gradient(120px 80px at 80% 10%, rgba(255,255,255,.08), transparent 70%),
      linear-gradient(180deg, #0e1325 0, #0c1020 100%);
    border-radius:12px; border:1px solid rgba(255,255,255,.06); overflow:hidden;
  }
  .pet{
    position:absolute; inset:auto 0 12% 0; margin:auto; width:44%; min-width:160px; pointer-events:auto; cursor:pointer;
    transition:transform .15s ease; image-rendering:pixelated; transform-origin:50% 50%;
  }
  .pet.happy{animation:bob 1.6s ease-in-out infinite}
  .pet.sad{filter:saturate(.7)}
  .pet.spin{animation:spin .6s linear}
  @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

  .bubble{
    position:absolute; left:10px; bottom:10px; padding:8px 10px; background:#101429; border:1px solid rgba(255,255,255,.08);
    border-radius:10px; font-size:13px; opacity:.95;
  }

  /* Effects container */
  .fx-area{position:absolute; inset:0; pointer-events:none; overflow:hidden}
  .fx-emoji{
    position:absolute; font-size:42px; opacity:0; transform:scale(.7);
    animation:pop .6s ease forwards;
  }
  @keyframes pop{0%{opacity:0; transform:scale(.7)}20%{opacity:1; transform:scale(1)}80%{opacity:1}100%{opacity:0; transform:scale(1.1)}}

  /* Action-specific particles */
  .particle{position:absolute; user-select:none; pointer-events:none}
  .fall{animation:fall 900ms ease-in forwards}
  @keyframes fall{0%{transform:translateY(-120px) rotate(-20deg); opacity:0}
                  10%{opacity:1}
                  80%{transform:translateY(110px) rotate(10deg)}
                  100%{transform:translateY(130px) scale(.9); opacity:0}}

  .confetti{font-size:18px; animation:confetti 900ms ease-out forwards}
  @keyframes confetti{
    0%{transform:translateY(-40px) rotate(0); opacity:0}
    10%{opacity:1}
    100%{transform:translateY(160px) rotate(300deg); opacity:0}
  }

  .bubbleUp{font-size:26px; animation:bubbleUp 1100ms ease-out forwards}
  @keyframes bubbleUp{
    0%{transform:translateY(80px) scale(.6); opacity:0}
    10%{opacity:1}
    100%{transform:translateY(-120px) scale(1.1); opacity:0}
  }

  .zzz{font-size:28px; animation:zzz 1400ms ease-in-out forwards}
  @keyframes zzz{
    0%{transform:translate(0,20px); opacity:0}
    10%{opacity:1}
    100%{transform:translate(-40px,-120px); opacity:0}
  }

  .heart{font-size:28px; animation:heart 1000ms ease-out forwards}
  @keyframes heart{
    0%{transform:translateY(10px) scale(.6); opacity:0}
    20%{opacity:1}
    100%{transform:translateY(-120px) scale(1.2); opacity:0}
  }

  /* Bars */
  .bars{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:12px 2px 8px}
  #bar-age{grid-column:span 2;}
  .bar{background:#0d1226; border:1px solid rgba(255,255,255,.06); border-radius:10px; padding:8px; position:relative; overflow:hidden}
  .bar label{display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; opacity:.85; margin-bottom:6px}
  .meter{height:8px; background:#070b19; border-radius:6px; overflow:hidden}
  .meter > i{display:block; height:100%; width:50%; background:linear-gradient(90deg, #2bdfff, #6ae3ff)}
  .meter.good > i{background:linear-gradient(90deg, var(--good), #7cf28a)}
  .meter.warn > i{background:linear-gradient(90deg, var(--warn), #ffd666)}
  .meter.bad  > i{background:linear-gradient(90deg, var(--bad),  #ff8082)}
  .pulse{animation:pulse 400ms ease}
  @keyframes pulse{0%{box-shadow:0 0 0 rgba(255,255,255,0)}50%{box-shadow:0 0 0 6px rgba(255,255,255,.08)}100%{box-shadow:0 0 0 rgba(255,255,255,0)}}

  /* Buttons / footer */
  .actions{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-top:10px}
  button{
    appearance:none; border:none; background:#0f1736; color:var(--text); padding:10px 8px; border-radius:10px; cursor:pointer;
    border:1px solid rgba(255,255,255,.08); font-weight:600; font-size:13px; transition:transform .08s ease, background .2s ease, opacity .2s ease;
  }
  button:hover{transform:translateY(-1px)}
  button:active{transform:translateY(0)}
  button[disabled]{opacity:.45; cursor:not-allowed}
  .foot{display:flex; align-items:center; justify-content:space-between; margin-top:10px; font-size:12px; opacity:.9; gap:8px}
  .left{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .reset{opacity:.7}
    .sound{
      display:inline-flex; align-items:center; gap:6px; background:#0f1736; border:1px solid rgba(255,255,255,.1);
      border-radius:20px; padding:6px 10px; font-size:12px;
    }
    .sound input{accent-color:var(--cat1)}

  /* Setup screen */
  .setup{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.8); z-index:100;
  }
  .setup-card{ 
    background:var(--panel); padding:20px; border-radius:12px; width:90%; max-width:300px;
    text-align:center; border:1px solid rgba(255,255,255,.1);
  }
  .setup-card input[type="text"]{
    width:100%; padding:8px; border-radius:8px; border:none; margin:8px 0;
  }
  .setup-card .gender{display:flex; gap:12px; justify-content:center; margin:8px 0;}
  .setup-card .gender label{display:flex; gap:4px; align-items:center; cursor:pointer;}
  .info{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.8); z-index:120;}
  .info-card{background:var(--panel); padding:20px; border-radius:12px; width:90%; max-width:300px; text-align:left; border:1px solid rgba(255,255,255,.1);}
  .info-card button{margin-top:12px;}
  .info-btn{position:absolute; top:8px; right:8px; background:none; border:none; color:var(--text); opacity:.8; cursor:pointer; font-size:18px;}
    .color{
      display:inline-flex; align-items:center; gap:6px; background:#0f1736; border:1px solid rgba(255,255,255,.1);
      border-radius:20px; padding:6px 10px; font-size:12px;
    }
    .color input{background:transparent; border:none; width:18px; height:18px; cursor:pointer; padding:0;}
  .toast{
    position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#0f1736; border:1px solid rgba(255,255,255,.1); border-radius:12px;
    padding:10px 14px; font-size:13px; opacity:0; pointer-events:none;
  }
  .toast.show{animation:toast .9s ease}
  @keyframes toast{0%{opacity:0; transform:translate(-50%, 8px)}12%{opacity:1; transform:translate(-50%, 0)}80%{opacity:1}100%{opacity:0; transform:translate(-50%, -6px)}}

  @media (max-width:380px){ .actions{grid-template-columns:repeat(3,1fr)} }
</style>
</head>
<body>
  <div class="setup" id="setup">
    <div class="setup-card">
      <h2>Welcome!</h2>
      <input type="text" id="setupName" placeholder="Your name" />
      <div class="gender">
        <label><input type="radio" name="gender" value="boy"> Boy</label>
        <label><input type="radio" name="gender" value="girl"> Girl</label>
      </div>
      <button id="setupGo">Start</button>
    </div>
  </div>
  <div class="info" id="info">
    <div class="info-card">
      <h2>How to Play</h2>
      <p>Keep Catzee happy by feeding, playing, cleaning and letting it sleep. Watch the bars and don't let them drop!</p>
      <button id="infoClose">Got it!</button>
    </div>
  </div>
  <h1 class="app-name">Catzee</h1>
  <div class="game" id="game">
    <button id="infoBtn" class="info-btn" title="How to play">ℹ️</button>
    <div class="top">
      <div class="title player-name" id="playerName">Player</div>
      <div class="clock" id="clock">--:--</div>
    </div>

    <div class="stars" id="stars">☆☆☆☆☆</div>

    <div class="viewport" id="viewport">
      <svg class="pet happy" id="pet" viewBox="0 0 200 180" xmlns="http://www.w3.org/2000/svg" aria-label="Catzee cat">
          <defs>
            <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%"  stop-color="var(--cat1)"/>
              <stop offset="100%" stop-color="var(--cat2)"/>
            </linearGradient>
          </defs>
          <ellipse cx="100" cy="95" rx="80" ry="70" fill="url(#g1)"/>
          <polygon points="36,80 80,10 100,80" fill="url(#g1)"/>
          <polygon points="164,80 120,10 100,80" fill="url(#g1)"/>
          <polygon points="48,78 80,25 100,78" fill="var(--catInner)"/>
          <polygon points="152,78 120,25 100,78" fill="var(--catInner)"/>
        <ellipse cx="78" cy="70" rx="16" ry="10" fill="rgba(255,255,255,.45)"/>
        <circle id="eyeL" cx="70" cy="90" r="10" fill="#071223"/>
        <circle id="eyeR" cx="130" cy="90" r="10" fill="#071223"/>
        <circle id="blinkL" cx="70" cy="90" r="10" fill="#071223" opacity="0"/>
        <circle id="blinkR" cx="130" cy="90" r="10" fill="#071223" opacity="0"/>
        <polygon id="nose" points="100,100 94,110 106,110" fill="#071223"/>
        <path id="mouth" d="M80 115 Q100 130 120 115" stroke="#071223" stroke-width="6" fill="none" stroke-linecap="round"/>
        <path d="M50 105 H20" stroke="#071223" stroke-width="4" stroke-linecap="round"/>
        <path d="M50 115 H20" stroke="#071223" stroke-width="4" stroke-linecap="round"/>
        <path d="M150 105 H180" stroke="#071223" stroke-width="4" stroke-linecap="round"/>
        <path d="M150 115 H180" stroke="#071223" stroke-width="4" stroke-linecap="round"/>
        <circle cx="55" cy="110" r="6" fill="rgba(255,105,180,.55)"/>
        <circle cx="145" cy="110" r="6" fill="rgba(255,105,180,.55)"/>
      </svg>

      <div class="fx-area" id="fxArea"></div>
      <div class="bubble" id="bubble">I’m feeling great!</div>
    </div>

    <div class="bars">
      <div class="bar" id="bar-hunger">
        <label><span>Hunger</span><b id="hungerText">100</b></label>
        <div class="meter" id="hungerMeter"><i></i></div>
      </div>
      <div class="bar" id="bar-fun">
        <label><span>Fun</span><b id="funText">100</b></label>
        <div class="meter" id="funMeter"><i></i></div>
      </div>
      <div class="bar" id="bar-energy">
        <label><span>Energy</span><b id="energyText">100</b></label>
        <div class="meter" id="energyMeter"><i></i></div>
      </div>
      <div class="bar" id="bar-hygiene">
        <label><span>Hygiene</span><b id="hygieneText">100</b></label>
        <div class="meter" id="hygieneMeter"><i></i></div>
      </div>
      <div class="bar" id="bar-age">
        <label><span>Age</span><b id="ageLevel">1/10</b></label>
        <div class="meter" id="ageMeter"><i></i></div>
      </div>
    </div>

    <div class="actions">
      <button id="btnFeed"   title="Feed">🍔 Feed</button>
      <button id="btnPlay"   title="Play">🎲 Play</button>
      <button id="btnClean"  title="Clean">🧼 Clean</button>
      <button id="btnSleep"  title="Sleep">😴 Sleep</button>
      <button id="btnHeal"   title="Heal">💊 Heal</button>
    </div>

    <div class="foot">
      <div class="left">
        <span>Age: <b id="age">0d</b> • Mood: <b id="mood">Happy</b></span>
        <label class="sound" title="Toggle sounds">
          <input type="checkbox" id="soundToggle" checked />
          <span>Sound</span>
        </label>
        <label class="color" title="Choose color">
          🎨 <input type="color" id="colorPicker" />
        </label>
        <label class="color" title="Background color">
          🌈 <input type="color" id="bgColorPicker" />
        </label>
      </div>
      <button class="reset" id="btnReset" title="Start over">Reset</button>
    </div>
  </div>

  <div class="toast" id="toast">Saved</div>

<script>
(function(){
  const EL = s => document.getElementById(s);

  const defaults = {
    hunger: 80, fun: 80, energy: 80, hygiene: 80,
    ageMinutes: 0, sleeping: false, sick: false, last: Date.now(),
    stars: 0, starStart: Date.now(),
    sound: true, color: '#6ae3ff', bgColor: '',
    gender: null, name: ''
  };
  const state = Object.assign({}, defaults, load() || {});

  const TICK_MS = 1000;
  const DECAY = { hunger: 4, fun: 3, energy: 2, hygiene: 2 };
  const AGE_MINUTES_PER_LEVEL = 60*24;

  function getAgeLevel(){
    return Math.min(Math.floor(state.ageMinutes / AGE_MINUTES_PER_LEVEL), 9);
  }
  function getMaturity(){
    return 1 - getAgeLevel()*0.05;
  }

  const fxArea = EL('fxArea');
  const bubble = EL('bubble');
  const pet = EL('pet');
  const mouth = EL('mouth');
  const blinkL = EL('blinkL'), blinkR = EL('blinkR');

  const meters = {
    hunger: EL('hungerMeter'),
    fun: EL('funMeter'),
    energy: EL('energyMeter'),
    hygiene: EL('hygieneMeter')
  };
  const texts = {
    hunger: EL('hungerText'),
    fun: EL('funText'),
    energy: EL('energyText'),
    hygiene: EL('hygieneText')
  };

  const colorPicker = EL('colorPicker');
  const bgColorPicker = EL('bgColorPicker');
  const themeMeta   = document.querySelector('meta[name="theme-color"]');
  const playerNameEl   = EL('playerName');
  const ageMeter = EL('ageMeter');
  const ageLevelText = EL('ageLevel');
  const setup       = EL('setup');
  const setupName   = EL('setupName');
  const setupGo     = EL('setupGo');
  const info        = EL('info');
  const infoBtn     = EL('infoBtn');
  const infoClose   = EL('infoClose');

  function shadeColor(color, percent){
    let f = parseInt(color.slice(1),16), t = percent < 0 ? 0 : 255, p = Math.abs(percent);
    let R = f >> 16, G = f >> 8 & 0x00FF, B = f & 0x0000FF;
    return '#' + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 +
                  (Math.round((t - G) * p) + G) * 0x100 +
                  (Math.round((t - B) * p) + B)).toString(16).slice(1);
  }

  function setCatColor(hex){
    document.documentElement.style.setProperty('--cat1', shadeColor(hex, 0.15));
    document.documentElement.style.setProperty('--cat2', shadeColor(hex,-0.15));
    document.documentElement.style.setProperty('--catInner', shadeColor(hex, 0.05));
    document.documentElement.style.setProperty('--accent', hex);
    if(themeMeta) themeMeta.setAttribute('content', shadeColor(hex, 0.15));
  }

  function setBgColor(hex){
    document.body.style.background = `radial-gradient(1200px 800px at 20% 10%, ${shadeColor(hex,0.1)} 0, ${hex} 45%, ${shadeColor(hex,-0.1)} 100%)`;
  }

  function applyGender(){
    document.body.classList.remove('boy','girl');
    document.body.classList.add(state.gender || 'boy');
  }

  applyGender();
  playerNameEl.textContent = state.name ? `😺 ${state.name}` : '🐱 Catzee';
  if(state.bgColor) setBgColor(state.bgColor);
  if(!state.gender || !state.name){
    setup.style.display = 'flex';
  }

  setupGo.onclick = () => {
    const genderEl = document.querySelector('input[name="gender"]:checked');
    const name = setupName.value.trim();
    if(!genderEl || !name) return;
    state.gender = genderEl.value;
    state.name = name;
    save();
    applyGender();
    playerNameEl.textContent = `😺 ${state.name}`;
    setup.style.display = 'none';
  };

  colorPicker.value = state.color;
  setCatColor(state.color);
  colorPicker.oninput = () => { state.color = colorPicker.value; setCatColor(state.color); save(); };

  bgColorPicker.value = state.bgColor || '#0f1220';
  bgColorPicker.oninput = () => { state.bgColor = bgColorPicker.value; setBgColor(state.bgColor); save(); };

  infoBtn.onclick = () => { info.style.display = 'flex'; };
  infoClose.onclick = () => { info.style.display = 'none'; };

  // Double-tap spin on the main character
  function spinPet(){
    const wasHappy = pet.classList.contains('happy');
    pet.classList.remove('happy');
    pet.classList.add('spin');
    pet.addEventListener('animationend', () => {
      pet.classList.remove('spin');
      if(wasHappy) pet.classList.add('happy');
    }, {once:true});
  }
  let lastTap = 0;
  pet.addEventListener('pointerup', () => {
    const now = Date.now();
    if(now - lastTap < 300) spinPet();
    lastTap = now;
  });

  // Buttons
  EL('btnFeed').onclick  = () => act('feed');
  EL('btnPlay').onclick  = () => act('play');
  EL('btnClean').onclick = () => act('clean');
  EL('btnSleep').onclick = () => act('sleep');
  EL('btnHeal').onclick  = () => act('heal');
  EL('btnReset').onclick = () => { localStorage.removeItem('catzee'); location.reload(); };

  // Sound toggle
  const soundToggle = EL('soundToggle');
  soundToggle.checked = !!state.sound;
  soundToggle.onchange = () => { state.sound = soundToggle.checked; save(); };

  // Clock
  setInterval(()=> EL('clock').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);

  // Main loop
  let loop = setInterval(tick, TICK_MS);
  catchUp();

  /* ---------- WebAudio (tiny synth) ---------- */
  let audioCtx = null;
  function ensureAudio(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      if(audioCtx.state === 'suspended') audioCtx.resume();
    }catch(e){ /* ignore */ }
  }
  document.addEventListener('mousedown', ensureAudio, {once:true});
  document.addEventListener('touchstart', ensureAudio, {once:true});
  function beep({freq=440, dur=0.12, type='sine', gain=0.06, slideTo=null, endGain=0.0} = {}){
    if(!state.sound) return;
    ensureAudio(); if(!audioCtx) return;
    const t0 = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, t0);
    if(slideTo){ osc.frequency.exponentialRampToValueAtTime(Math.max(1, slideTo), t0 + Math.max(0.01, dur)); }
    g.gain.setValueAtTime(gain, t0);
    g.gain.exponentialRampToValueAtTime(Math.max(0.0001,endGain), t0 + dur);
    osc.connect(g).connect(audioCtx.destination);
    osc.start(t0); osc.stop(t0 + dur + 0.02);
  }
  const sounds = {
    feed(){ beep({freq:300, dur:0.08, type:'square', gain:0.08}); setTimeout(()=>beep({freq:220, dur:0.09, type:'square', gain:0.07}), 70); },
    play(){ beep({freq:660, dur:0.12, type:'triangle', gain:0.07}); setTimeout(()=>beep({freq:880, dur:0.10, type:'triangle', gain:0.06}), 90); },
    clean(){ beep({freq:900, dur:0.15, type:'sine', gain:0.05, slideTo:1400}); },
    sleep(on){ if(on) beep({freq:220, dur:0.25, type:'sine', gain:0.05}); else beep({freq:520, dur:0.18, type:'triangle', gain:0.06}); },
    heal(){ beep({freq:520, dur:0.1, type:'sine', gain:0.06}); setTimeout(()=>beep({freq:780, dur:0.12, type:'sine', gain:0.06}), 100); }
  };

  /* ---------- Core loop ---------- */
  function tick(){
    const now = Date.now();
    const dt = (now - (state.last || now)) / 60000; // minutes
    state.last = now;

    const mult = state.sleeping ? 0.3 : 1;
    const maturity = getMaturity();
    state.hunger = clamp(state.hunger - DECAY.hunger*dt*mult*maturity, 0, 100);
    state.fun    = clamp(state.fun    - DECAY.fun*dt*(state.sleeping?0.15:1)*maturity, 0, 100);
    state.hygiene= clamp(state.hygiene- DECAY.hygiene*dt*maturity, 0, 100);
    state.energy = clamp(state.energy + (state.sleeping? +18*dt : -DECAY.energy*dt*maturity), 0, 100);

    if(Math.random() < 0.005 && state.hygiene < 45){
      toast("Uh-oh, a little mess appeared. Clean up! 🧹");
      state.hygiene = clamp(state.hygiene - 8, 0, 100);
    }

    state.sick = (state.hunger < 20 || state.hygiene < 20 || state.energy < 10);
    state.ageMinutes += dt;
    const allGood = ['hunger','fun','energy','hygiene'].every(k => state[k] >= 70);
    if(allGood){
      if(!state.starStart) state.starStart = now;
      if(now - state.starStart >= 3600000){
        if(state.stars < 5){
          state.stars++;
          toast('Star earned! ⭐');
          spawnConfetti();
        }
        state.starStart = now;
        save();
      }
    } else {
      state.starStart = now;
    }
    updateUI();
    if(Math.random() < 0.2) save();
  }

  function act(type){
    switch(type){
      case 'feed':
        bump('hunger', +28, 'bar-hunger'); bump('energy', +6, 'bar-energy');
        spawnBurger(); speak("Yum! Thank you!");
        happyBounce();
        sounds.feed();
        break;
      case 'play':
        if(state.sleeping){ speak("Zzz... maybe later."); wobble(); break; }
        bump('fun', +24, 'bar-fun'); bump('energy', -10);
        spawnConfetti(); speak("Weeee! That was fun!");
        happyBounce();
        sounds.play();
        break;
      case 'clean':
        bump('hygiene', +30, 'bar-hygiene');
        spawnBubbles(); speak("So fresh and so clean!");
        sounds.clean();
        break;
      case 'sleep':
        state.sleeping = !state.sleeping;
        speak(state.sleeping ? "Goodnight… 😴" : "I’m up! 🌞");
        pet.classList.toggle('happy', !state.sleeping);
        spawnZzz();
        sounds.sleep(state.sleeping);
        break;
      case 'heal':
        if(state.sick){
          bump('hunger', +10, 'bar-hunger'); bump('hygiene', +10, 'bar-hygiene'); bump('energy', +10, 'bar-energy');
          state.sick = false; spawnHearts(); speak("Feeling better already!");
          sounds.heal();
        } else { speak("I’m okay!"); wobble(); }
        break;
    }
    save();
    updateUI();
    if(['feed','play','clean','heal'].includes(type)) animateMouth();
  }

  function bump(key, delta, pulseId){
    const before = state[key];
    state[key] = clamp(state[key] + delta, 0, 100);
    if(pulseId && state[key] > before){
      const el = EL(pulseId);
      el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
    }
  }
  const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));

  function updateUI(){
    ['hunger','fun','energy','hygiene'].forEach(k=>{
      const v = Math.round(state[k]);
      texts[k].textContent = v;
      const i = meters[k].querySelector('i');
      i.style.width = v + '%';
      meters[k].classList.remove('good','warn','bad');
      meters[k].classList.add(v>=66?'good':v>=33?'warn':'bad');
    });

    EL('stars').textContent = '★'.repeat(state.stars) + '☆'.repeat(5 - state.stars);

    const agePercent = Math.min(state.ageMinutes / (AGE_MINUTES_PER_LEVEL*10) * 100, 100);
    ageMeter.querySelector('i').style.width = agePercent + '%';
    ageLevelText.textContent = `${getAgeLevel()+1}/10`;

    const avg = (state.hunger + state.fun + state.energy + state.hygiene)/4;
    let mood = 'Happy', msg = "I’m feeling great!";
    if(state.sleeping){ mood = 'Sleeping'; msg = "Zzz…"; }
    else if(state.sick){ mood = 'Sick'; msg = "I don’t feel good."; }
    else if(avg < 33){ mood = 'Sad'; msg = "Can we fix my needs?"; }
    else if(avg < 66){ mood = 'Okay'; msg = "Doing alright."; }
    EL('mood').textContent = mood;
    bubble.textContent = msg;

    mouth.setAttribute('d',
      mood==='Happy' ? "M80 115 Q100 130 120 115" :
      mood==='Sad'   ? "M80 125 Q100 112 120 125" :
      mood==='Sick'  ? "M80 118 Q100 118 120 118" :
      "M80 120 Q100 125 120 120"
    );
    pet.classList.toggle('happy', mood==='Happy' && !state.sleeping);
    pet.classList.toggle('sad',   mood==='Sad' || state.sick);

    if(Math.random()<0.05 && !state.sleeping) blink();

    // Only disable play during sleep
    EL('btnPlay').disabled = state.sleeping;

    const mins = Math.floor(state.ageMinutes);
    const d = Math.floor(mins/ (60*24));
    const h = Math.floor(mins/60) % 24;
    EL('age').textContent = `${d}d ${h}h`;
  }

  function speak(text){
    bubble.textContent = text;
    clearTimeout(speak._t);
    speak._t = setTimeout(updateUI, 1600);
  }

  function happyBounce(){
    pet.style.transform = 'translateY(-6px)'; setTimeout(()=> pet.style.transform = 'translateY(0)', 160);
  }
  function wobble(){
    pet.style.transform = 'rotate(-4deg)'; setTimeout(()=> pet.style.transform = 'rotate(0)', 140);
  }
  function blink(){
    blinkL.setAttribute('opacity','1'); blinkR.setAttribute('opacity','1');
    setTimeout(()=>{ blinkL.setAttribute('opacity','0'); blinkR.setAttribute('opacity','0'); }, 120);
  }

  function animateMouth(){
    mouth.setAttribute('d',"M80 115 Q100 145 120 115");
    setTimeout(updateUI,200);
  }

  /* ---------- Particles / animations ---------- */
  function spawn(el, cls, x, y, text){
    el = document.createElement('div');
    el.className = `particle ${cls}`;
    el.textContent = text || '';
    el.style.left = (x||Math.random()*80+10) + '%';
    el.style.top  = (y||10) + '%';
    fxArea.appendChild(el);
    setTimeout(()=> el.remove(), 1600);
  }

  function spawnBurger(){
    const x = 50 + (Math.random()*20 - 10);
    for(let i=0;i<1;i++){
      spawn(null,'fall', x, -5, '🍔');
    }
    // little crumbs
    for(let i=0;i<4;i++){
      setTimeout(()=>spawn(null,'confetti', x+(Math.random()*20-10), 10, ['🍟','🥐','🥨','🥪'][i%4]), 80+i*40);
    }
  }

  function spawnConfetti(){
    for(let i=0;i<14;i++){
      const x = Math.random()*90+5;
      setTimeout(()=>spawn(null,'confetti', x, -5, ['🎉','✨','🎈','🎊'][i%4]), i*25);
    }
    // emoji pop near pet
    popFx('😄');
  }

  function spawnBubbles(){
    for(let i=0;i<10;i++){
      const x = Math.random()*70+15;
      setTimeout(()=>spawn(null,'bubbleUp', x, 60+Math.random()*10, '🫧'), i*60);
    }
    popFx('🧼');
  }

  function spawnZzz(){
    if(state.sleeping){
      for(let i=0;i<5;i++){
        const x = 65 + Math.random()*15;
        setTimeout(()=>spawn(null,'zzz', x, 55+Math.random()*6, 'Z'), i*300);
      }
    } else {
      popFx('🌞');
    }
  }

  function spawnHearts(){
    for(let i=0;i<6;i++){
      const x = 40 + Math.random()*20;
      setTimeout(()=>spawn(null,'heart', x, 50+Math.random()*6, ['💖','💗','💓'][i%3]), i*120);
    }
  }

  function popFx(symbol){
    const d = document.createElement('div');
    d.className = 'fx-emoji';
    d.textContent = symbol;
    d.style.left = '50%'; d.style.top = '45%'; d.style.transform = 'translate(-50%,-50%) scale(.7)';
    fxArea.appendChild(d);
    setTimeout(()=>d.remove(), 650);
  }

  /* ---------- Persistence ---------- */
  function save(){
    localStorage.setItem('catzee', JSON.stringify(state));
    if(Math.random()<0.08) toast('Progress saved');
  }
  function load(){
    const raw = localStorage.getItem('catzee'); if(!raw) return null;
    try{ return JSON.parse(raw); }catch{ return null; }
  }
  function catchUp(){
    const now = Date.now();
    const last = state.last || now;
    const minutesAway = (now - last)/60000;
    if(minutesAway > 0.2){
      const maturity = getMaturity();
      ['hunger','fun','energy','hygiene'].forEach(k=>{
        state[k] = clamp(state[k] - DECAY[k]*(minutesAway/1)*maturity, 0, 100);
      });
      state.ageMinutes += minutesAway;
    }
    state.last = now;
    updateUI();
  }

  function toast(msg){
    const el = EL('toast');
    el.textContent = msg;
    el.classList.remove('show'); void el.offsetWidth; el.classList.add('show');
    clearTimeout(toast._t); toast._t = setTimeout(()=> el.classList.remove('show'), 900);
  }

  // Kick off: first user gesture will unlock audio on mobile, but we also try once.
  ensureAudio();
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js');
    let refreshing;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (refreshing) return;
      refreshing = true;
      window.location.reload();
    });
  }
})();
</script>
</body>
</html>